!function(t,e){"function"==typeof define&&define.amd?define(["bluebird","underscore","uuid/v4"],e):"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(exports=module.exports=e(require("bluebird"),require("underscore"),require("uuid/v4"))):("function"==typeof require&&(t.Promise=require("bluebird"),t._=require("underscore"),t.uuidv4=require("uuid/v4")),t.FSM=e(t.Promise,t._,t.uuidv4))}(this,function(t,e,i){"use strict";function _eachEntity(t,e){var i,n,s,r,o;for(e(t),i=0,s=t._regions.length;i<s;i+=1){for(e(o=t._regions[i]),n=0,r=o._transits.length;n<r;n+=1)e(o._transits[n]);for(n=0,r=o._states.length;n<r;n+=1)_eachEntity(o._states[n],e)}}function _findState(t,i,n){var s,r,o,a,h,c,_;if((n=e.isUndefined(n)?1/0:n)>=0)for(n-=1,s=0,o=t._states.length;s<o;s+=1){if((h=t._states[s])===i)return h;for(r=0,a=h._regions.length;r<a;r+=1)if(c=h._regions[r],_=_findState(c,i,n),!e.isUndefined(_))return _}}function _findDeepHistoryPseudoState(t){var i;return t.hasHistory(!0)?t._historyPseudo:(i=t._getUpperContainer(),e.isNull(i)?void 0:_findDeepHistoryPseudoState(i))}function _findFirstTransition(t,i){var n=t._transits;return e.isUndefined(i)&&(i=t._initialPseudo),e.find(n,function(t){return t._source===i})}function _findNextTransition(t,i,n){var s=t._transits;return e.find(s,function(t){return e.isUndefined(n)?i instanceof P?t._source===i:t._source===i&&!t._locked:t._source===i&&t._target===n})}var n,s,r,o,a,h,c,_,u,l,d,f,p,m,v,y,g,b,S,x,P,O,N;return o={config:{debuggable:!0}},n={logLevel:"DEBUG",logLevelData:["DEBUG","INFO","WARN","ERROR"],debug:function(t){o.config.debuggable&&e.indexOf(this.logLevelData,this.logLevel)<=0&&console.log("DEBUG: ",t)},info:function(t){o.config.debuggable&&e.indexOf(this.logLevelData,this.logLevel)<=1&&console.log("INFO: ",t)},warn:function(t){o.config.debuggable&&e.indexOf(this.logLevelData,this.logLevel)<=2&&console.log("WARN: ",t)},error:function(t){if(o.config.debuggable&&e.indexOf(this.logLevelData,this.logLevel)<=3)throw console.error("ERROR: ",t),new Error("ERROR: "+t)}},s=e.negate(Boolean),r={accessor:{get:function(t){return this.model.get(t)},set:function(t,e){return this.model.set(t,e)},unset:function(t){return this.model.unset(t)},extend:function(t){return this.model.extend(t)},save:function(){this.model.save()},restore:function(){this.model.restore()},clear:function(){this.model.clear()}},helper:{$get:function(t){var i=this._getSuperState();if(!e.isNull(i))return i.model.get(t)},$set:function(t,i){var n=this._getSuperState();if(!e.isNull(n))return n.model.set(t,i)},$unset:function(t){var i=this._getSuperState();if(!e.isNull(i))return i.model.unset(t)},$extend:function(t){var i=this._getSuperState();if(!e.isNull(i))return i.model.extend(t)},$save:function(){var t=this._getSuperState();if(e.isNull(t))return!1;t.model.save()},$restore:function(){var t=this._getSuperState();if(e.isNull(t))return!1;t.model.restore()},$clear:function(){var t=this._getSuperState();if(e.isNull(t))return!1;t.model.clear()}},disable:{get:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},set:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},unset:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},extend:function(t){n.error(this._cname+"インスタンスは内部データを保持できません。")},save:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},restore:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},clear:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},$props:null,$methods:null,$get:function(t){n.error(this._cname+"インスタンスは内部データを保持できません。")},$set:function(t,e){n.error(this._cname+"インスタンスは内部データを保持できません。")},$unset:function(t){n.error(this._cname+"インスタンスは内部データを保持できません。")},$extend:function(t){n.error(this._cname+"インスタンスは内部データを保持できません。")},$save:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},$restore:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},$clear:function(){n.error(this._cname+"インスタンスは内部データを保持できません。")},addState:function(){n.error(this._cname+"インスタンスはサブ状態を持てません。")},removeState:function(){n.error(this._cname+"インスタンスはサブ状態を持てません。")},addTransition:function(t){n.error(this._cname+"インスタンスは遷移を持てません。")},removeTransition:function(t){n.error(this._cname+"インスタンスは遷移を持てません。")},appendRegion:function(t){n.error(this._cname+"インスタンスは領域を持てません。")},removeRegion:function(t){n.error(this._cname+"インスタンスは領域を持てません。")}},descriptor:{$props:{enumerable:!0,get:function(){var t=this._getSuperState();if(!e.isNull(t))return t.props}},$methods:{enumerable:!0,get:function(){var t=this._getSuperState();if(!e.isNull(t))return t.methods}}},manipulator:{state:{addState:function(){var t=e.toArray(arguments);return e.isNull(this.region)&&(this.appendRegion(),n.info(this._cname+'インスタンス"'+this._name+'"のRegionインスタンスが自動生成されました。')),this.region.addState.apply(this.region,t)},removeState:function(){var t=e.toArray(arguments);return e.isNull(this.region)&&n.error("コンテナのRegionインスタンスが存在しません。"),this.region.removeState.apply(this.region,t)},addTransition:function(){var t=e.toArray(arguments);return e.isNull(this.region)&&(this.appendRegion(),n.info(this._cname+'インスタンス"'+this._name+'"のRegionインスタンスが自動作成されました。')),this.region.addTransition.apply(this.region,t)},removeTransition:function(){var t=e.toArray(arguments);return e.isNull(this.region)&&n.error("コンテナのRegionインスタンスが存在しません。"),this.region.removeTransition.apply(this.region,t)},appendRegion:function(t){return e.isNull(this.region)?(e.isUndefined(t)?t=new N("default-region-of-"+this._name):t instanceof N||n.error("Regionインスタンスを指定してください。"),this.region=t):e.isUndefined(t)?t=new N(!1):t instanceof N||n.error("Regionインスタンスを指定してください。"),t._parent=this,this._regions.push(t),this._addObserver("regions",t),t._addObserver("parent",this),t._update("update-relation"),t},removeRegion:function(t){var i;return t instanceof N||n.error("Regionインスタンスを指定してください。"),t._parent=null,(i=e.indexOf(this._regions,t))>-1?this._regions.splice(i,1):n.error("削除対象のRegionインスタンスが見つかりません。"),this.region===t&&(this.region=null),t._update("update-relation"),this._removeObserver("regions",t),t._removeObserver("parent",this),t}},region:{addState:function(){var t,i,s,r,o,a;for(i=0,s=(t=e.toArray(arguments)).length;i<s;i+=1)(r=t[i])instanceof u||n.error("Stateインスタンスを指定してください。"),r instanceof v?this._initialPseudo=r:r instanceof f?this._final=r:r instanceof y&&(this._historyPseudo=r),this._states.push(r),this._states[r._id]=r,this._addObserver("states",r),r._container=this,r._addObserver("container",this),o=this._getParentLevel()+1,a=this._getRoot(),r._updateRelation(o,a);return t.length>1?t:e.first(t)},removeState:function(){var t,i,n;for(t=e.toArray(arguments),i=this._states.length;i--;)n=this._states[i],e.indexOf(t,n)>-1&&(n instanceof y&&(this._historyPseudo=null),this._states.splice(i,1),delete this._states[n._id],this._removeObserver("states",n),n._container=null,n._removeObserver("container",this),n._updateRelation(0,null));return t.length>1?t:e.first(t)},addTransition:function(){var t,i,r,o,a,h,c;for(i=0,r=(t=e.toArray(arguments)).length;i<r;i+=1)(o=t[i])instanceof O||n.error("Transitionインスタンスを指定してください。"),o._rawSource===v||s(o._rawSource)?o._source=this._initialPseudo:(a=_findState(this,o._rawSource,0),e.isUndefined(a)&&(a=_findState(this,o._rawSource,1),e.isUndefined(a)?n.error("遷移元のStateインスタンスが見つかりません。"):o._exitViaExitPoint=!0),o._source=o._rawSource),o._rawTarget===f||s(o._rawTarget)?o._target=this._final:(a=_findState(this,o._rawTarget,0),e.isUndefined(a)&&(a=_findState(this,o._rawTarget,1),e.isUndefined(a)?n.error("遷移先のStateインスタンスが見つかりません。"):o._isExplicitEntry=!0),o._target=o._rawTarget),o._name===o._id&&(o._name="transit-from-"+o._source._name+"-to-"+o._target._name),this._transits.push(o),this._transits[o._id]=o,this._addObserver("transits",o),o._container=this,o._addObserver("container",this),h=this._getParentLevel()+1,c=this._getRoot(),o._updateRelation(h,c);return t.length>1?t:e.first(t)},removeTransition:function(){var t,i,n;for(t=e.toArray(arguments),i=this._transits.length;i--;)n=this._transits[i],e.indexOf(t,n)>-1&&(this._transits.splice(i,1),delete this._transits[n._id],this._removeObserver("transits",n),n._source=null,n._target=null,n._container=null,n._removeObserver("container",this),n._updateRelation(0,null));return t.length>1?t:e.first(t)}},subMachine:{addLink:function(t){t instanceof d||n.error("Machineインスタンスを指定してください。"),this._link=t,this._addObserver("outbound",t),t._addObserver("inbound",this)},removeLink:function(){this._removeObserver("outbound",this._link),this._link._removeObserver("inbound",this),this._link=null}}}},a=function(t){this._data={},this._cache=null,e.isObject(t)&&this._extendDeep(this._data,t)},a.prototype=e.create(Object.prototype,{constructor:a,get:function(t){return this._data[t]},set:function(t,e){return this._data[t]=e,e},unset:function(t){var i=this._data[t];if(!e.isUndefined(i))return delete this._data[t],i},extend:function(t){return this._extendDeep(this._data,t)},save:function(){this._extendDeep(this._cache,this._data)},restore:function(){e.isNull(this._cache)||(this._data={},this._extendDeep(this._data,this._cache))},clear:function(){this._data={},this._cache=null},_cname:"Model",_extendDeep:function(t,i){return t=t||{},e.each(i,e.bind(function(i,s){e.isObject(i)?(e.isFunction(i)&&n.error("Functionはdataプロパティに登録できません。methodsプロパティに登録してください。"),t[s]=e.isArray(i)?[]:{},this._extendDeep(t[s],i)):t[s]=i},this)),t}}),h=function(){this._observers={}},h.prototype=e.create(Object.prototype,{constructor:h,_cname:"Subject",_countObservers:function(t){var i=0;return e.isUndefined(this._observers[t])||(i=this._observers[t].length),i},_setObserverType:function(){var t,i,n,s;for(n=0,s=(t=e.toArray(arguments)).length;n<s;n+=1)i=t[n],e.isUndefined(this._observers[i])&&(this._observers[i]=[])},_addObserver:function(t,i){e.isUndefined(this._observers[t])&&(this._observers[t]=[]),this._observers[t].push(i)},_removeObserver:function(t,i){var s,r;s=this._observers[t],e.isUndefined(s)?n.warn("オブザーバーが登録されていません。"):(r=e.indexOf(s,i))>-1&&s.splice(r,1)},_notify:function(t){var i,s,r,o,a;if(i=this._observers[t],a=e.toArray(arguments).slice(1),e.isUndefined(i))n.warn("オブザーバーが登録されていません。");else for(s=0,r=i.length;s<r;s+=1)o=i[s],e.isFunction(o._update)&&o._update.apply(o,a)}}),c=function(t){h.call(this),this._id=i(),this._name=s(t)?this._id:t,this._type="entity",this._status="inactive",this.model=new a,this.props={},this.methods={},this._setObserverType("root")},c.prototype=e.create(h.prototype,e.extend({constructor:c,getId:function(){return this._id},getName:function(){return this._name},setName:function(t){return this._name=t,t},isActive:function(){return"active"===this._status},addMethod:function(t){var i,n;return i=this,n=e.mapObject(t,function(t){return e.bind(t,i)}),e.extend(this.methods,n),this.methods},_cname:"Entity",_activate:function(){this._status="active",n.info(this._cname+'インスタンス"'+this._name+'"がアクティブ化されました。')},_inactivate:function(){this._status="inactive",n.info(this._cname+'インスタンス"'+this._name+'"が非アクティブ化されました。')},_update:e.noop},r.accessor)),_=function(t){c.call(this,t),this._type="element",this._container=null,this._root=null,this._level=0,this._setObserverType("container"),Object.defineProperties(this,r.descriptor)},_.prototype=e.create(c.prototype,e.extend({constructor:_,getContainer:function(){return this._container},getCurrentLevel:function(){return this._level},_cname:"Elem",_async:function(i){this._notify("root","async",e.bind(function(){return e.bind(i,this)(),t.resolve()},this))}},r.helper)),u=function(t){_.call(this,t),this._type="state",this.region=null,this._regions=[],this._setObserverType("regions")},u.prototype=e.create(_.prototype,e.extend({constructor:u,getRegion:function(t){return e.isNumber(t)?this._regions[t]:this.region},completion:function(){this._async(function(){this.isActive()?(this._exit(),e.isNull(this._container)?n.error(this._cname+'インスタンス"'+this._name+'"のコンテナが存在しません。'):this._notify("container","completion")):n.error(this._cname+'インスタンス"'+this._name+'"はすでに非アクティブ化されています。')})},_cname:"ProtoState",_getSuperState:function(){var t=null;return e.isNull(this._container)||e.isNull(this._container._parent)||(t=this._container._parent),t},_update:function(t){var i=e.toArray(arguments).slice(1);switch(t){case"entry":this._entry.apply(this,i);break;case"exit":this._exit.apply(this,i);break;case"update-relation":this._updateRelation.apply(this,i);break;case"completion":this.completion.apply(this,i)}},_updateRelation:function(t,e){this._level=t,this._root=e,this._notify("regions","update-relation")},_entry:function(){this.isActive()||(this._activate(),this._notify("regions","entry"))},_exit:function(){this.isActive()&&(this._notify("regions","exit"),this._inactivate())}},r.manipulator.state)),l=function(t,i){u.call(this,t),i=e.defaults(i||{},e.clone(l.options)),e.isObject(i.data)&&this.extend(i.data),this.save(),e.isObject(i.props)&&e.extend(this.props,i.props),e.isObject(i.methods)&&this.addMethod(i.methods),this._entryAction=i.entryAction,this._exitAction=i.exitAction,this._doActivity=i.doActivity,this._autoTransition=i.autoTransition,this._loop=i.loop,this._fps=i.fps,this._interval=1e3/this._fps,this._timerId=0,this._lastCallTime=0},l.options={entryAction:e.noop,exitAction:e.noop,doActivity:e.noop,autoTransition:!1,loop:!1,fps:60},l.prototype=e.create(u.prototype,{constructor:l,completion:function(){this._async(function(){var t;this.isActive()?e.isNull(this._container)?n.error(this._cname+'インスタンス"'+this._name+'"のコンテナが存在しません。'):(t=_findNextTransition(this._container,this),e.isUndefined(t)?(this._exit(),this._notify("container","completion")):t.trigger()):n.error(this._cname+'インスタンス"'+this._name+'"はすでに非アクティブ化されています。')})},_cname:"State",_update:function(t){var i=e.toArray(arguments).slice(1);switch(t){case"entry":this._entry.apply(this,i);break;case"exit":this._exit.apply(this,i);break;case"update-relation":this._updateRelation.apply(this,i);break;case"completion":this.completion.apply(this,i)}},_setTimer:function(t){this._timerId=0,this._lastCallTime=0,this._repeat(t)},_clearTimer:function(){clearTimeout(this._timerId)},_repeat:function(t){var i,n,s;return i=e.now(),n=0!==this._lastCallTime?i-this._lastCallTime:0,s=Math.max(this._interval-n,0),this._lastCallTime=i+s,this._timerId=setTimeout(e.bind(this._timeout,this,t,i,n),s),this._timerId},_timeout:function(t,i,n){t(e.now()-i+n),this._repeat(t)},_activate:function(){var t,i,s,r;t=this._root,e.isNull(t)?n.error("Machineインスタンスの参照が存在しません。"):(i=t.model,s=t.props,r=t.methods),this._status="active",n.info(this._cname+'インスタンス"'+this._name+'"がアクティブ化されました。'),this._entryAction(i,s,r),this._loop?this._setTimer(e.bind(function(t){this._doActivity(t,i,s,r),this._autoTransition&&this.completion()},this)):(this._doActivity(i,s,r),this._autoTransition&&this.completion())},_inactivate:function(){var t,i,s,r;t=this._root,e.isNull(t)?n.error("Machineインスタンスの参照が存在しません。"):(i=t.model,s=t.props,r=t.methods),this._clearTimer(),e.isNull(this._container)||this._notify("container","set-previous-state",this),this._exitAction(i,s,r),this._status="inactive",n.info(this._cname+'インスタンス"'+this._name+'"が非アクティブ化されました。')},_entry:function(t,e){this.isActive()||(this._activate(),this._notify("regions","entry",t,e))}}),d=function(t,i){u.call(this,t,i),i=i||{},e.isObject(i.data)&&this.extend(i.data),this.save(),e.isObject(i.props)&&e.extend(this.props,i.props),e.isObject(i.methods)&&this.addMethod(i.methods),this._deployed=!1,this._promise=null,this.appendRegion(),this._setObserverType("inbound")},d.prototype=e.create(u.prototype,{constructor:d,deploy:function(){return this._deployed=!0,this._promise=t.resolve(),this._updateRelation(this._level,this),_eachEntity(this,e.bind(function(t){t instanceof d||t._addObserver("root",this)},this)),this},undeploy:function(){return this._deployed=!1,this._promise=null,_eachEntity(this,e.bind(function(t){t instanceof d||t._removeObserver("root",this)},this)),this._updateRelation(this._level,null),this},start:function(i){return this._deployed||n.error("start()の前にdeploy()メソッドを実行してください。"),this.isActive()?n.warn('Machineインスタンス"'+this._name+'"はすでに起動しています。'):(n.info('Machineインスタンス"'+this._name+'"が動作を開始しました。'),this._stackPromise(e.bind(function(){return this._entry(void 0,i),t.resolve()},this))),this},finish:function(){return this._deployed||n.error("start()の前にdeploy()メソッドを実行してください。"),this.isActive()?this.completion():n.warn('Machineインスタンス"'+this._name+'"はすでに動作を終了しています。'),this},completion:function(){this._stackPromise(e.bind(function(){return this._exit(),n.info('Machineインスタンス"'+this._name+'"が動作を終了しました。'),t.resolve()},this))},_cname:"Machine",_stackPromise:function(t){this._promise=this._promise.then(t).catch(this._onRejected)},_aborted:function(t){n.error('Machineインスタンス"'+this._name+'"は処理を停止しました。')},_outerExecution:function(t){var i,s,r,o;if(e.isUndefined(t))this.start();else{for(i=0,s=this._regions.length;i<s;i+=1)if(r=this._regions[i],o=r._states[t],!e.isUndefined(o))return void this.start(o);n.error("エンドポイントのEntryPointPseudoStateインスタンスが指定されていません。")}},_linkBack:function(i){this.completion(),this._stackPromise(e.bind(function(){return this._notify("inbound","link-back",i._id),t.resolve()},this))},_update:function(t,i){var n=e.toArray(arguments).slice(1);switch(t){case"async":this._stackPromise(i);break;case"entry":this._entry.apply(this,n);break;case"exit":this._exit.apply(this,n);break;case"completion":this.completion.apply(this,n);break;case"termination":this._aborted.apply(this,n);break;case"link-forward":this._outerExecution.apply(this,n);break;case"exit-point":this._linkBack.apply(this,n)}},_onRejected:function(e){return n.info(e),t.reject(e)},_entry:function(t,e){this.isActive()||(this._activate(),this._notify("regions","entry",t,e))}}),f=function(t){u.call(this,t)},f.prototype=e.create(u.prototype,e.extend({constructor:f,_cname:"FinalState",_activate:function(){this._status="active",n.info('FinalStateインスタンス"'+this._name+'"がアクティブ化されました。'),this.completion()},_inactivate:function(){this._status="inactive",e.isNull(this._container)||this._notify("container","set-previous-state",null),n.info('FinalStateインスタンス"'+this._name+'"が非アクティブ化されました。')}},r.disable)),p=function(t){u.call(this,t),this._link=null,this._deployed=!1,this.appendRegion(),this._setObserverType("outbound")},p.prototype=e.create(u.prototype,e.extend({constructor:p,deploy:function(){return this._deployed=!0,_eachEntity(this,e.bind(function(t){t instanceof u&&(t instanceof m?t instanceof S?(t._addObserver("sub-root",this),t._getSuperState()===this?t._isMediator=!0:n.error("ConnectionPointPseudoStateインスタンスはサブマシン直下のサブ状態でなければなりません。")):t instanceof v||n.error("SubMachineインスタンスはConnectionPointPseudoStateクラス以外の状態を追加できません。"):t instanceof p||t instanceof f||n.error("SubMachineインスタンスはConnectionPointPseudoStateクラス以外の状態を保持できません。"))},this)),this},undeploy:function(){return this._deployed=!1,_eachEntity(this,e.bind(function(t){t instanceof u&&(t instanceof m?t instanceof S?(t._removeObserver("sub-root",this),t._isMediator=!1):t instanceof v||n.error("SubMachineインスタンスはConnectionPointPseudoStateクラス以外の状態を追加できません。"):t instanceof p||t instanceof f||n.error("SubMachineインスタンスはConnectionPointPseudoStateクラス以外の状態を保持できません。"))},this)),this},_cname:"SubMachine",_linkForward:function(t){this._async(e.bind(function(){t._exit(),e.isEmpty(t._key)?n.error("リンク先のマシンに渡すキーが指定されていません。"):this._notify("outbound","link-forward",t._key)},this))},_innerExecution:function(t){var i,s,r,o;for(s=0,r=this._regions.length;s<r;s+=1)o=this._regions[s],i=e.findWhere(o._states,{_key:t}),e.isUndefined(i)?n.error("エンドポイントのExitPointPseudoStateインスタンスが指定されていません。"):i._entry()},_update:function(t){var i=e.toArray(arguments).slice(1);switch(t){case"entry-point":this._linkForward.apply(this,i);break;case"link-back":this._innerExecution.apply(this,i)}},_entry:function(t,e){this._deployed||n.error("SubMachineインスタンスのdeploy()メソッドを実行してください。"),this.isActive()||(this._activate(),this._notify("regions","entry",t,e))},_exit:function(){this._deployed||n.error("SubMachineインスタンスのdeploy()メソッドを実行してください。"),this.isActive()&&(this._notify("regions","exit"),this._inactivate())}},r.manipulator.subMachine)),m=function(t){u.call(this,t),this._type="pseudo-state"},m.prototype=e.create(u.prototype,e.extend({constructor:m,_cname:"PseudoState",_inactivate:function(){this._status="inactive",e.isNull(this._container)||this._notify("container","set-previous-state",null),n.info(this._cname+'インスタンス"'+this._name+'"が非アクティブ化されました。')}},r.disable)),v=function(t){m.call(this,t)},v.prototype=e.create(m.prototype,{constructor:v,_cname:"InitialPseudoState",_activate:function(){var t;this._status="active",n.info('InitialPseudoStateインスタンス"'+this._name+'"がアクティブ化されました。'),e.isNull(this._container)?n.error('InitialPseudoStateインスタンス"'+this._name+'"のコンテナが存在しません。'):(t=_findFirstTransition(this._container),e.isUndefined(t)?n.error('Regionインスタンス"'+this._container._name+'"の初期遷移が見つかりません。'):t.trigger())}}),y=function(t,i){m.call(this,t),this._isDeep=!e.isUndefined(i)&&i},y.prototype=e.create(m.prototype,{constructor:y,_cname:"HistoryPseudoState"}),g=function(t){m.call(this,t)},g.prototype=e.create(m.prototype,{constructor:g,_cname:"TerminatePseudoState",_activate:function(){throw this._status="active",n.info('TerminatePseudoStateインスタンス"'+this._name+'"がアクティブ化されました。'),this._notify("root","termination",this),new Error("ERROR: 停止状態に遷移しました。処理を中断します。")}}),b=function(t,i){m.call(this,t),this._condition=e.isFunction(i)?i:e.noop},b.prototype=e.create(m.prototype,{constructor:b,_cname:"ChoicePseudoState",_activate:function(){var t,i,s,r,o,a;t=this._root,e.isNull(t)?n.error("Machineインスタンスの参照が存在しません。"):(i=t.model,s=t.props,r=t.methods),this._status="active",n.info('ChoicePseudoStateインスタンス"'+this._name+'"がアクティブ化されました。'),(o=this._condition(i,s,r))instanceof u||n.error("遷移先のStateインスタンスが存在しません。"),e.isNull(this._container)?n.error('ChoicePseudoStateインスタンス"'+this._name+'"のコンテナが存在しません。'):(a=_findNextTransition(this._container,this,o),e.isUndefined(a)?n.error('ChoicePseudoStateインスタンス"'+this._name+'"起点のTransitionインスタンスが見つかりません。'):a.trigger())}}),S=function(t){m.call(this,t),this._key="",this._isMediator=!1,this._setObserverType("sub-root")},S.prototype=e.create(m.prototype,{constructor:S,setKey:function(t){return this._key=t,t},_cname:"ConnectionPointPseudoState"}),x=function(t){S.call(this,t)},x.prototype=e.create(S.prototype,{constructor:x,_cname:"EntryPointPseudoState",_activate:function(){var t;this._status="active",n.info('EntryPointPseudoStateインスタンス"'+this._name+'"がアクティブ化されました。'),this._isMediator?this._notify("sub-root","entry-point",this):e.isNull(this._container)?n.error('EntryPointPseudoStateインスタンス"'+this._name+'"のコンテナが存在しません。'):(t=_findFirstTransition(this._container,this),e.isUndefined(t)?n.error('Regionインスタンス"'+this._container._name+'"の初期遷移が見つかりません。'):t.trigger())}}),P=function(t){S.call(this,t)},P.prototype=e.create(S.prototype,{constructor:P,_cname:"ExitPointPseudoState",_activate:function(){var t,i;this._status="active",n.info('ExitPointPseudoStateインスタンス"'+this._name+'"がアクティブ化されました。'),this._isMediator?(t=this._container._getUpperContainer(),e.isNull(t)?n.error('ExitPointPseudoStateインスタンス"'+this._name+'"の上位コンテナが存在しません。'):(i=_findNextTransition(t,this),e.isUndefined(i)?n.error('ExitPointPseudoStateインスタンス"'+this._name+'"起点のTransitionインスタンスが見つかりません。'):i.trigger())):this._notify("root","exit-point",this)}}),O=function(t,i,r,o){_.call(this,t),this._type="transition",i instanceof u||s(i)||v?this._rawSource=i:n.error("第2引数に遷移元のStateインスタンス、またはfalseを指定してください。"),r instanceof u||s(r)||f?this._rawTarget=r:n.error("第3引数に遷移元のStateインスタンス、またはfalseを指定してください。"),o=e.defaults(o||{},e.clone(O.options)),e.isObject(o.data)&&this.extend(o.data),this.save(),e.isObject(o.props)&&e.extend(this.props,o.props),e.isObject(o.methods)&&this.addMethod(o.methods),this._source=null,this._target=null,this._guard=o.guard,this._effect=o.effect,this._internal=o.internal,this._locked=o.locked,this._isExplicitEntry=!1,this._exitViaExitPoint=!1},O.options={guard:null,effect:null,internal:!1,locked:!0},O.prototype=e.create(_.prototype,{constructor:O,trigger:function(){var t,i,s,r;if(t=this._root,e.isNull(t)?n.error("Machineインスタンスの参照が存在しません。"):(i=t.model,s=t.props,r=t.methods),e.isNull(this._container)&&n.error('Transitionインスタンス"'+this._name+'"のコンテナが存在しません。'),this._container.isActive()||n.error('Transitionインスタンス"'+this._name+'"のコンテナが非アクティブです。'),this._source instanceof f?n.error("終了状態を遷移元にすることはできません。"):this._source instanceof g?n.error("停止状態を遷移元にすることはできません。"):this._target instanceof v&&n.error("開始擬似状態を遷移先にすることはできません。"),e.isNull(this._guard)||this._guard(i,s,r)){if(this._internal){if(this._source===this._target)return void this._async(function(){n.info("内部遷移を実行します。"),e.isNull(this._effect)||this._effect(i,s,r)});n.error("遷移元と遷移先は同じStateインスタンスを指定してください。")}this._async(function(){var t;this.isActive()?n.error('Transitionインスタンス"'+this._name+'"はすでにアクティブ化されています。'):this._activate(),this._source.isActive()?this._exitViaExitPoint?(t=this._source._getSuperState(),e.isNull(t)?n.error(this._target._cname+'インスタンス"'+this._target._name+'"の「親」状態が存在しません。'):t._exit()):this._source._exit():n.error("遷移元"+this._target._cname+'インスタンス"'+this._target._name+'"が非アクティブです。'),e.isNull(this._effect)||this._effect(i,s,r),this._target.isActive()?n.error("遷移先"+this._target._cname+'インスタンス"'+this._target._name+'"がアクティブです。'):this._isExplicitEntry?(t=this._target._getSuperState(),e.isNull(t)?n.error(this._target._cname+'インスタンス"'+this._target._name+'"の「親」状態が存在しません。'):t._entry(void 0,this._target)):this._target._entry(),this.isActive()?this._inactivate():n.error('Transitionインスタンス"'+this._name+'"はすでに非アクティブ化されています。')})}else n.info("ガードが成立しませんでした。遷移は発生しません。")},_cname:"Transition",_update:function(t){var i=e.toArray(arguments).slice(1);switch(t){case"update-relation":this._updateRelation.apply(this,i)}},_updateRelation:function(t,e){this._level=t,this._root=e}}),N=function(t,i){c.call(this,t),this._type="region",i=i||{},e.isObject(i.data)&&this.extend(i.data),this.save(),e.isObject(i.props)&&e.extend(this.props,i.props),e.isObject(i.methods)&&this.addMethod(i.methods),this._parent=null,this._initialPseudo=null,this._final=null,this._historyPseudo=null,this._previousState=null,this._states=[],this._transits=[],this._setObserverType("parent","states","transits"),this._setDefaultStates()},N.prototype=e.create(c.prototype,e.extend({constructor:N,hasHistory:function(t){return s(t)?!e.isNull(this._historyPseudo):!e.isNull(this._historyPseudo)&&this._historyPseudo._isDeep},getIndex:function(){return e.isNull(this._parent)&&e.indexOf(this._parent._regions,this),-1},_cname:"Region",_update:function(t){var i=e.toArray(arguments).slice(1);switch(t){case"entry":this._entry.apply(this,i);break;case"exit":this._exit.apply(this,i);break;case"update-relation":this._updateRelation.apply(this,i);break;case"completion":this._completion.apply(this,i);break;case"set-previous-state":this._setPreviousState.apply(this,i)}},_getParentLevel:function(){var t=-1;return e.isNull(this._parent)||(t=this._parent._level),t},_getRoot:function(){return e.isNull(this._parent)?null:this._parent._root},_getUpperContainer:function(){var t=null;return e.isNull(this._parent)||e.isNull(this._parent._container)||(t=this._parent._container),t},_setDefaultStates:function(){var t,e;t=new v(!1),e=new f(!1),this.addState(t,e)},_setDefaultStateName:function(){this._initialPseudo._name="initial-pseudo-state-in-"+this._name,this._final._name="final-state-in-"+this._name},_updateRelation:function(){var t,e;this._setDefaultStateName(),t=this._getParentLevel()+1,e=this._getRoot(),this._notify("states","update-relation",t,e),this._notify("transits","update-relation",t,e)},_setPreviousState:function(t){return this._previousState=t,t},_entry:function(t,i){var n;this.isActive()||(this._activate(),e.isUndefined(t)&&(t=_findDeepHistoryPseudoState(this),t=!e.isUndefined(t)),e.indexOf(this._states,i)>-1?i._update("entry",t):(t?n=this._previousState||this._initialPseudo:e.isNull(this._historyPseudo)?n=this._initialPseudo:(n=this._previousState||this._initialPseudo,this._historyPseudo._isDeep&&(t=!0)),n._update("entry",t,i)))},_exit:function(){this.isActive()&&(this._notify("states","exit"),this._inactivate())},_completion:function(){this._inactivate(),e.isNull(this._parent)?n.error('Regionインスタンス"'+this._name+'"の「親」状態が存在しません。'):e.every(this._parent._regions,function(t){return!t.isActive()})&&this._notify("parent","completion")}},r.manipulator.region)),o=e.extend(o,{Machine:d,State:l,Transition:O,Region:N,InitialPseudoState:v,FinalState:f,SubMachine:p,HistoryPseudoState:y,TerminatePseudoState:g,ChoicePseudoState:b,EntryPointPseudoState:x,ExitPointPseudoState:P})});
//# sourceMappingURL=async-fsm.min.js.map
